import{m as b,k as h,v as y,r as v,e as w,n as S,o as I,p as d}from"./index-5e2885e4.js";import{DagSidebar as C}from"./index-0a3009fd.js";import{DagCanvas as _}from"./index-2004026b.js";import{DagToolbar as E}from"./index-1e0da8c5.js";import{g as N,a as j,b as A,c as $,d as k,s as z}from"./index-2d941bf7.js";import{u as O,N as R}from"./index-4e4366ce.js";import{_ as D}from"./lodash-11edae60.js";import{u as q}from"./use-message-88af69a6.js";import{N as x}from"./Space-d49acb7b.js";import"./sql-57bdd75b.js";import"./gForce-f4cb6a07.js";import"./debounce-19376a56.js";import"./_baseMap-d2a29d52.js";import"./get-53588a31.js";import"./common-341af126.js";import"./SettingOutlined-d17049cc.js";import"./index-5de39f79.js";import"./EditOutlined-0243f050.js";import"./PlayCircleOutlined-e103aa1f.js";import"./node-97f48230.js";import"./Tooltip-5624ecb6.js";import"./Popover-907f9950.js";import"./cssr-7767064c.js";import"./format-length-c9d165c6.js";import"./use-merged-state-d459d80e.js";import"./use-compitable-248ca92d.js";import"./next-frame-once-7035a838.js";import"./node-setting-8ed1de72.js";import"./node-model-04f38f3f.js";import"./column-width-config-b963bc25.js";import"./split-modal-885ce1d9.js";import"./FormItem-7f69a4d7.js";import"./Input-1bbd5e95.js";import"./use-locale-ba0171d5.js";import"./Suffix-9f9d022f.js";import"./Form-6e61837b.js";import"./Dropdown-8ccd025e.js";import"./Icon-b461a67a.js";import"./create-bbda4d67.js";import"./DeleteOutlined-099c0ef1.js";import"./CopyOutlined-9b4275f0.js";import"./composables-ca7679f2.js";import"./Grid-7fd51304.js";import"./Empty-dd1b91e9.js";import"./DataTable-bb49b036.js";import"./Checkbox-2d4945a3.js";import"./RadioGroup-92bc79b0.js";import"./Select-94feec49.js";import"./configuration-form-6b272f26.js";import"./use-form-structure-b872a9e7.js";import"./service-d19f0ccd.js";import"./Tabs-11369ba4.js";import"./Add-c7f60439.js";import"./throttle-c6377e77.js";import"./index.module-a00bcd5b.js";import"./layout-modal-ae1b700c.js";import"./index-0bca5bb9.js";import"./task-setting-modal-188a304e.js";import"./FullscreenOutlined-c3c6909f.js";const T=()=>{const o=b(),s=h(),m=q(),{t:p}=y.useI18n(),u=O(),n=v({loading:!1});return{state:n,detailInit:async()=>{if(!n.loading){n.loading=!0;try{const[i,l,r]=await Promise.all([N(o.params.jobDefinitionCode),j(o.params.jobDefinitionCode),A(o.params.jobDefinitionCode)]),e=i?await Promise.all(i.plugins.map(async t=>{if(t.type==="SOURCE")return{...await $(String(t.dataSourceId),t.tableOption),pluginId:t.pluginId,name:t.name}})):null;return e&&(i.plugins=i.plugins.map(t=>(t.type==="SOURCE"&&e.map(a=>{a&&t.pluginId===a.pluginId&&(a.databases.length>0&&m.warning(`(${a.name}-${a.pluginId})[${a.databases.toString()}] ${p("project.synchronization_definition.database_exception_message")}`,{closable:!0,duration:0}),a.tables.length>0&&m.warning(`(${a.name}-${a.pluginId})[${a.tables.toString()}] ${p("project.synchronization_definition.table_exception_message")}`,{closable:!0,duration:0}),D.pullAll(t.tableOption.databases,a.databases),D.pullAll(t.tableOption.tables,a.tables))}),t))),u.setDagInfo({...l,...r}),{nodesAndEdges:i}}finally{n.loading=!1}}},onDelete:async i=>{try{return await k(o.params.jobDefinitionCode,i),!0}catch{return!1}},onSave:async(i,l)=>{if(n.loading)return!1;n.loading=!0;try{const r=await z(o.params.jobDefinitionCode,i);if(r){const e=l.getCellById(r.pluginId);e.getData().isError=!0,e.getData().schemaError=r.schemaError,l.resetCells(l.getCells()),window.$message.error(JSON.stringify(r.schemaError||""),{closable:!0,duration:0})}else s.push({name:"synchronization-definition",query:{project:o.query.project,global:o.query.global}});return n.loading=!1,!0}catch{return n.loading=!1,!1}}}},L={"workflow-dag":"_workflow-dag_2qmsh_17"},Je=w({name:"SynchronizationDefinitionDag",setup(){const o=S(),s={type:"",name:""},{t:m}=y.useI18n(),{state:p,detailInit:u,onDelete:n,onSave:g}=T(),f=(e,t)=>{s.type=e,s.name=t},c=e=>{s.type&&o.value.addNode({x:e.offsetX,y:e.offsetY,label:s.name||s.type,node:s.type})},i=async()=>{const e=o.value.getSelectedCells();if(!e.length){window.$message.warning(m("project.synchronization_definition.delete_empty_tips"));return}let t=!0;e[0].isNode()&&!e[0].getData().unsaved&&(t=await n(e[0].getData().pluginId)),t&&o.value.removeCell(e[0].id)},l=()=>{o.value.getDagData()&&g(o.value.getDagData(),o.value.getGraph())},r=(e,t,a)=>{o.value.layoutDag(e,t,a)};return I(async()=>{const e=await u();e!=null&&e.nodesAndEdges&&o.value.addNodesAndEdges(e.nodesAndEdges.plugins,e.nodesAndEdges.edges)}),()=>d(R,{show:p.loading},{default:()=>[d(x,{vertical:!0},{default:()=>[d(E,{onDelete:i,onSave:l,onLayout:r},null),d("div",{class:L["workflow-dag"]},[d(C,{onDragstart:f},null),d(_,{onDrop:c,ref:o},null)])]})]})}});export{Je as default};
