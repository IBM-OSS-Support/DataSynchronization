import{e as x,ar as A,as as X,at as $,v as L,n as J,i as n,q as v,m as Z,r as Q,w as Y,p as h,W as ee,X as te,s as ie}from"./index-5e2885e4.js";import{q,n as ne,o as oe}from"./index-2d941bf7.js";import{C as f,c as C,D as B}from"./column-width-config-b963bc25.js";import{l as k}from"./lodash-11edae60.js";import ae from"./split-modal-885ce1d9.js";import{E as G}from"./EditOutlined-0243f050.js";import{N as W,a as le}from"./Dropdown-8ccd025e.js";import{N as w,D as M}from"./DeleteOutlined-099c0ef1.js";import{C as se}from"./CopyOutlined-9b4275f0.js";import{u as re}from"./composables-ca7679f2.js";import{N as H}from"./Input-1bbd5e95.js";import{N as V}from"./FormItem-7f69a4d7.js";import{N}from"./Icon-b461a67a.js";import{N as I}from"./Space-d49acb7b.js";import{N as U}from"./Tooltip-5624ecb6.js";import{a as F,N as ce}from"./Grid-7fd51304.js";import{N as pe}from"./Empty-dd1b91e9.js";import{N as P}from"./DataTable-bb49b036.js";import"./service-d19f0ccd.js";import"./Form-6e61837b.js";import"./Popover-907f9950.js";import"./_baseMap-d2a29d52.js";import"./get-53588a31.js";import"./cssr-7767064c.js";import"./format-length-c9d165c6.js";import"./use-merged-state-d459d80e.js";import"./use-compitable-248ca92d.js";import"./next-frame-once-7035a838.js";import"./create-bbda4d67.js";import"./use-locale-ba0171d5.js";import"./Suffix-9f9d022f.js";import"./Checkbox-2d4945a3.js";import"./RadioGroup-92bc79b0.js";import"./Select-94feec49.js";const ue={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 1024 1024"},de=$("path",{d:"M840 836H184c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h656c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8zm0-724H184c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h656c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8zM610.8 378c6 0 9.4-7 5.7-11.7L515.7 238.7a7.14 7.14 0 0 0-11.3 0L403.6 366.3a7.23 7.23 0 0 0 5.7 11.7H476v268h-62.8c-6 0-9.4 7-5.7 11.7l100.8 127.5c2.9 3.7 8.5 3.7 11.3 0l100.8-127.5c3.7-4.7.4-11.7-5.7-11.7H548V378h62.8z",fill:"currentColor"},null,-1),me=[de],fe=x({name:"ColumnHeightOutlined",render:function(m,_){return A(),X("svg",ue,me)}}),he={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 1024 1024"},_e=$("path",{d:"M847.9 592H152c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h605.2L612.9 851c-4.1 5.2-.4 13 6.3 13h72.5c4.9 0 9.5-2.2 12.6-6.1l168.8-214.1c16.5-21 1.6-51.8-25.2-51.8zM872 356H266.8l144.3-183c4.1-5.2.4-13-6.3-13h-72.5c-4.9 0-9.5 2.2-12.6 6.1L150.9 380.2c-16.5 21-1.6 51.8 25.1 51.8h696c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z",fill:"currentColor"},null,-1),ye=[_e],be=x({name:"SwapOutlined",render:function(m,_){return A(),X("svg",he,ye)}}),ge=()=>{const{t:i}=L.useI18n(),m=re(),_=J(),p=(g,y)=>{m.create({title:i("project.synchronization_definition.split_field"),content:()=>n(ae,{rowData:g,outputData:y,ref:_}),onPositiveClick:()=>{const{outputFields:d,separator:e,original_field:c}=_.value.getFields();d.forEach(l=>{y.push({...g,name:l,isSplit:!0,separator:e,original_field:c})});const O=y.filter(l=>!l.isSplit).map(l=>l.name);y.filter(l=>l.isSplit).map(l=>l.original_field).forEach(l=>{O.indexOf(l)>=0&&(y[O.indexOf(l)].splitDisabled=!0)})},positiveText:i("project.synchronization_definition.confirm"),negativeText:i("project.synchronization_definition.cancel")})};return{createColumns:({nodeType:g,columnSelectable:y,transformType:d,outputTableData:e})=>{const c=[{title:"#",key:"index",render:(l,b)=>b+1,...f.index},{title:i("project.synchronization_definition.field_name"),key:"name",...f.name},{title:i("project.synchronization_definition.field_type"),key:"type",...f.type,ellipsis:{tooltip:!0}},{title:i("project.synchronization_definition.non_empty"),key:"nullable",...f.index,render:l=>l.nullable?i("project.synchronization_definition.yes"):i("project.synchronization_definition.no")},{title:i("project.synchronization_definition.primary_key"),key:"primaryKey",...f.index,render:l=>l.primaryKey?i("project.synchronization_definition.yes"):i("project.synchronization_definition.no")},{title:i("project.synchronization_definition.field_comment"),key:"comment",...f.name,ellipsis:{tooltip:!0}},{title:i("project.synchronization_definition.default_value"),key:"defaultValue",...f.state,ellipsis:{tooltip:!0}}],O={type:"selection",disabled:l=>l.unSupport,...f.selection};if(g==="transform"&&d==="FieldMapper"){const l=k.cloneDeep(c),b={title:i("project.synchronization_definition.field_name"),key:"name",...f.name,render(o,r){return o.isEdit?n(V,{showLabel:!1,validationStatus:o.name?"success":"error",feedback:o.name?"":i("project.synchronization_definition.name_tips")},()=>n(H,{value:e[r].name,onUpdateValue(a){e[r].name=a},onBlur(){e[r].isEdit=!1}})):n("div",{align:"center",style:{display:"flex","flex-wrap":"no-wrap","align-items":"center"}},[n(W,{},[o.name]),n(v,{quaternary:!0,circle:!0,size:"small",onClick(){e[r].isEdit=!0}},{icon:n(N,null,()=>n(G))})])}};return l.splice(1,1,{title:i("project.synchronization_definition.original_field"),key:"original_field",...f.name,render:o=>n("span",{class:o.isError&&"row-error"},o.original_field)},b),l.push({title:i("project.synchronization_definition.operation"),key:"operation",...f.operation(2),render(o,r){return n(I,{},[n(le,{options:[{label:i("project.synchronization_definition.move_to_top"),disabled:r===0,key:"move_to_top"},{label:i("project.synchronization_definition.move_to_bottom"),disabled:r===e.length-1,key:"move_to_bottom"},{label:i("project.synchronization_definition.move_up"),disabled:r===0,key:"move_up"},{label:i("project.synchronization_definition.move_down"),disabled:r===e.length-1,key:"move_down"}],onSelect(a){if(a==="move_to_top"){const s=e.splice(r,1);e.unshift(s[0])}else if(a==="move_to_bottom"){const s=e.splice(r,1);e.push(s[0])}else a==="move_up"?R(e,r,r-1):a==="move_down"&&R(e,r,r+1)}},n(v,{circle:!0,size:"small",type:"info"},n(N,{style:"transform: rotate(90deg)"},()=>n(be)))),n(w,{onPositiveClick(){e.splice(r,1)}},{trigger:()=>n(v,{circle:!0,size:"small",type:"error"},n(N,{},()=>n(M))),default:()=>i("project.synchronization_definition.delete_confirm")})])}}),{inputColumns:y?[O,...c.slice(1)]:c,outputColumns:l,inputTableWidth:C(c),outputTableWidth:C(l)}}if(g==="transform"&&d==="MultiFieldSplit"){const l=k.cloneDeep(c),b={title:i("project.synchronization_definition.field_name"),key:"name",...f.name,render:o=>{const r=e.map(a=>a.name);return n("span",{class:r.indexOf(o.name)!==r.lastIndexOf(o.name)&&"row-error"},o.name)}};return l.splice(1,1,{title:i("project.synchronization_definition.original_field"),key:"original_field",...f.name,render:o=>n("span",{class:o.isError&&"row-error"},o.original_field)},b),l.push({title:i("project.synchronization_definition.operation"),key:"operation",...f.operation(1),width:60,render(o,r){return o.isSplit?n(w,{onPositiveClick(){k.remove(e,t=>t.original_field===o.original_field&&t.isSplit);const a=e.filter(t=>!t.isSplit).map(t=>t.name),s=e.filter(t=>t.isSplit).map(t=>t.original_field);a.forEach(t=>{s.indexOf(t)<0&&(e[a.indexOf(t)].splitDisabled=!1)})}},{trigger:()=>n(v,{circle:!0,size:"small",type:"error"},n(N,{},()=>n(M))),default:()=>i("project.synchronization_definition.delete_confirm")}):n(U,{},{trigger:()=>n(v,{circle:!0,size:"small",type:"info",disabled:o.splitDisabled,onClick(){p(o,e)}},n(N,{},()=>n(fe))),default:()=>i("project.synchronization_definition.split")})}}),{inputColumns:y?[O,...c.slice(1)]:c,outputColumns:l,inputTableWidth:C(c),outputTableWidth:C(l)}}if(g==="transform"&&d==="Copy"){const l=k.cloneDeep(c),b={title:i("project.synchronization_definition.field_name"),key:"name",...f.name,render:(o,r)=>{const a=e.map(s=>s.name);return o.copyTimes!==-1?n("span",{class:a.indexOf(o.name)!==a.lastIndexOf(o.name)&&"row-error"},o.name):o.isEdit?n(V,{showLabel:!1,validationStatus:o.name?"success":"error",feedback:o.name?"":i("project.synchronization_definition.name_tips")},()=>n(H,{value:e[r].name,onUpdateValue(s){e[r].name=s},onBlur(){e[r].isEdit=!1}})):n("div",{align:"center",style:{display:"flex","flex-wrap":"no-wrap","align-items":"center"}},[n(W,{},[o.name]),n(v,{quaternary:!0,circle:!0,size:"small",onClick(){e[r].isEdit=!0}},{icon:n(N,null,()=>n(G))})])}};return l.splice(1,1,{title:i("project.synchronization_definition.original_field"),key:"original_field",...f.name,render:o=>o.original_field},b),l.push({title:i("project.synchronization_definition.operation"),key:"operation",...f.operation(1),width:60,render(o,r){return o.copyTimes===-1?n(w,{onPositiveClick(){e.splice(r,1)}},{trigger:()=>n(v,{circle:!0,size:"small",type:"error"},n(N,{},()=>n(M))),default:()=>i("project.synchronization_definition.delete_confirm")}):n(U,{},{trigger:()=>n(v,{circle:!0,size:"small",type:"info",onClick(){const a=e.filter(t=>t.original_field===o.original_field&&t.original_field!==t.name),s=k.max(a.map(t=>Number(t.name.split(t.original_field)[1])));e[r].copyTimes=(s??0)+1,e.push({...o,name:o.name+o.copyTimes,copyTimes:-1})}},n(N,{},()=>n(se))),default:()=>i("project.synchronization_definition.copy_field")})}}),{inputColumns:y?[O,...c.slice(1)]:c,outputColumns:l,inputTableWidth:C(c),outputTableWidth:C(l)}}const z=()=>{const l=[...c],b={title:i("project.synchronization_definition.field_type"),key:"type",...f.type,ellipsis:{tooltip:!0},render:o=>o.outputDataType?o.outputDataType:o.type};return l.splice(2,1,b),l};return{inputColumns:y?[O,...c.slice(1)]:c,outputColumns:g!=="source"?c:z(),inputTableWidth:C(c),outputTableWidth:C(c)}}}};function R(i,m,_){const p=i[_];i[_]=i[m],i[m]=p}function Oe(i,m,_,p,S,g){const{createColumns:y}=ge(),d=Z(),e=Q({inputColumns:[],inputTableData:[],inputLoading:!1,outputColumns:[],outputTableData:[],allTableData:[],schemaError:{},optionsOutputTableData:[],transformOptions:{},secondTransformOptions:{},outputLoading:!1,currentTable:"",selectedKeys:[],tables:[],columnSelectable:!1,database:"",datasourceInstanceId:"",datasourceName:"",inputTableWidth:B,outputTableWidth:B,format:""});let c=[];const O=()=>{var a;if(i==="sink"||i==="transform"){if(m==="Sql"&&!((a=g.value.getValues())!=null&&a.query))return;_&&q(d.params.jobDefinitionCode,_).then(s=>{e.tables=s.outputSchema.map(t=>t.tableName),e.currentTable=s.outputSchema[0].tableName,e.allTableData=[{database:s.outputSchema[0].database,tableInfos:s.outputSchema}],s.transformOptions&&(e.transformOptions=s.transformOptions),b(e.currentTable)})}else ne(e.datasourceInstanceId,[{database:e.database,tables:e.tables}]).then(s=>{e.allTableData=s,b(e.currentTable)})},z=()=>{const{inputColumns:a,outputColumns:s,inputTableWidth:t,outputTableWidth:u}=y({nodeType:i,columnSelectable:e.columnSelectable,transformType:m,outputTableData:e.outputTableData});e.inputColumns=a,e.outputColumns=s,e.inputTableWidth=t,e.outputTableWidth=u},l=()=>{var s;let a=(s=g.value.getValues())==null?void 0:s.query;return oe(d.params.jobDefinitionCode,_,{sourceFieldName:null,query:a}).then(t=>t.fields)},b=a=>{e.currentTable=a,e.format!=="COMPATIBLE_DEBEZIUM_JSON"&&(e.allTableData[0].tableInfos.forEach(async s=>{if(s.tableName===e.currentTable)if(c=s.fields,e.inputTableData=s.fields.filter(t=>!t.isSplit),e.columnSelectable){if(e.optionsOutputTableData&&e.optionsOutputTableData[0].tableName===e.currentTable){const t=e.optionsOutputTableData?e.optionsOutputTableData[0].fields:c.filter(u=>e.selectedKeys.includes(u.name));e.outputTableData=t.filter(u=>!u.unSupport)}else e.outputTableData=c.filter(t=>!t.unSupport);e.selectedKeys=e.outputTableData.filter(t=>!t.unSupport).map(t=>t.name)}else if(m==="FieldMapper"){if(!e.secondTransformOptions&&!e.transformOptions)return e.outputTableData=e.inputTableData.map(u=>(u.original_field=u.name,u)),!1;const t=e.transformOptions.changeOrders?e.transformOptions:e.secondTransformOptions;e.outputTableData=e.optionsOutputTableData?e.optionsOutputTableData[0].fields:s.fields.map((u,T)=>({...u,original_field:t&&Object.keys(t).length>0?t.changeOrders[T].sourceFieldName:u.name})),e.outputTableData=e.outputTableData.map((u,T)=>(u.original_field||(u.original_field=t.changeOrders[T].sourceFieldName),u)),e.outputTableData.forEach(u=>{u.isError=u.original_field===e.schemaError.fieldName})}else if(m==="MultiFieldSplit")e.outputTableData=e.optionsOutputTableData?e.optionsOutputTableData[0].fields.map(t=>{if(e.transformOptions.splits||e.secondTransformOptions&&e.secondTransformOptions.splits){const u=e.transformOptions.splits?e.transformOptions:e.secondTransformOptions,T=u.splits.map(j=>j.sourceFieldName);t.splitDisabled=T.includes(t.name),u.splits.forEach(j=>{j.outputFields.includes(t.name)&&(t.original_field=j.sourceFieldName,t.separator=j.separator,t.isSplit=!0)}),t.original_field||(t.original_field=t.name)}return t}):s.fields.map(t=>({...t,original_field:t.name}));else if(m==="Copy")e.outputTableData=e.optionsOutputTableData?e.optionsOutputTableData[0].fields.map(t=>((e.transformOptions.copyList||e.secondTransformOptions&&e.secondTransformOptions.copyList)&&((e.transformOptions.copyList?e.transformOptions:e.secondTransformOptions).copyList.forEach(T=>{e.inputTableData.map(D=>D.name).includes(t.name)||(t.copyTimes=-1,T.targetFieldName===t.name?t.original_field=T.sourceFieldName:S&&q(d.params.jobDefinitionCode,S).then(D=>{D.transformOptions&&D.transformOptions.copyList.forEach(K=>{K.targetFieldName===t.name&&(t.original_field=K.sourceFieldName)})}))}),t.copyTimes!==-1&&(t.original_field=t.name)),t)):s.fields.map(t=>({...t,original_field:t.name}));else if(m==="Sql"){let t=await l();e.outputTableData=t}else e.outputTableData=s.fields}),z())},o=a=>{e.selectedKeys=a,e.outputTableData=c.filter(s=>a.includes(s.name))},r=a=>{e.currentTable=a.tables.length?a.tables[0]:"",e.tables=i==="sink"?[]:a.tables||[],e.columnSelectable=a.columnSelectable||!1,e.database=a.database||"",e.datasourceInstanceId=a.datasourceInstanceId||"",e.format=a.format,e.transformOptions=a.transformOptions,e.secondTransformOptions=a.transformOptions,e.schemaError=p,(a.sceneMode&&a.sceneMode==="SINGLE_TABLE"||m==="FieldMapper"||m==="MultiFieldSplit"||m==="Copy")&&(e.optionsOutputTableData=a.outputSchema),e.format==="COMPATIBLE_DEBEZIUM_JSON"?(e.inputTableData=[{name:"topic",type:"string"},{name:"key",type:"string"},{name:"value",type:"string"}],e.outputTableData=[{name:"topic",type:"string"},{name:"key",type:"string"},{name:"value",type:"string"}]):(i==="transform"||e.datasourceInstanceId)&&(i==="transform"||e.database)&&(i==="sink"||i==="transform"||e.tables.length)&&O(),z()};return Y(()=>L.useI18n().locale,()=>{z()}),{state:e,onSwitchTable:b,onUpdatedCheckedRowKeys:o,onInit:r}}const E={"list-container":"_list-container_1vmnn_17","dd-active":"_dd-active_1vmnn_32","adjust-th-height":"_adjust-th-height_1vmnn_36","table-container-margin":"_table-container-margin_1vmnn_40"};function Te(i){return typeof i=="function"||Object.prototype.toString.call(i)==="[object Object]"&&!ie(i)}const it=x({name:"NodeModeModal",props:{type:{type:String,default:"source"},transformType:{type:String,default:""},predecessorsNodeId:{type:String,default:""},currentNodeId:{type:String,default:""},schemaError:{type:Object,default:{}},refForm:{type:Object,default:null}},setup(i,{expose:m}){const{t:_}=L.useI18n(),{state:p,onInit:S,onSwitchTable:g,onUpdatedCheckedRowKeys:y}=Oe(i.type,i.transformType,i.predecessorsNodeId,i.schemaError,i.currentNodeId,i.refForm);return m({getOutputSchema:()=>({allTableData:p.allTableData,outputTableData:p.outputTableData,inputTableData:p.inputTableData}),getSelectFields:()=>({tableFields:p.selectedKeys,all:p.selectedKeys.length===p.inputTableData.length}),setSelectFields:d=>p.selectedKeys=d,initData:d=>{S(d)}}),()=>h(ce,{xGap:6},{default:()=>[h(F,{span:6,class:E["list-container"]},{default:()=>[h(I,{vertical:!0},{default:()=>[h("h3",null,[_("project.synchronization_definition.table_name")]),ee(h("dl",null,[p.tables.map(d=>h("dd",{class:d===p.currentTable?E["dd-active"]:"",onClick:()=>void g(d)},[h(W,null,Te(d)?d:{default:()=>[d]})]))]),[[te,p.tables.length]]),p.tables.length===0&&h(pe,null,null)]})]}),h(F,{span:i.type==="sink"?18:9},{default:()=>[h(I,{vertical:!0},{default:()=>[h("h3",null,[_("project.synchronization_definition.input_table_structure")]),h(P,{size:"small","row-class-name":E["adjust-th-height"],columns:p.inputColumns,data:p.inputTableData,onUpdateCheckedRowKeys:y,rowKey:d=>d.name,checkedRowKeys:p.selectedKeys,scrollX:p.inputTableWidth},null)]})]}),i.type!=="sink"&&h(F,{span:9},{default:()=>[h(I,{vertical:!0},{default:()=>[h("h3",null,[_("project.synchronization_definition.output_table_structure")]),h(P,{size:"small","row-class-name":E["adjust-th-height"],columns:p.outputColumns,data:p.outputTableData,scrollX:p.outputTableWidth},null)]})]})]})}});export{it as default};
